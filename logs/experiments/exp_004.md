# Experiment 004

## 실험 정보
- **날짜**: 2025-12-16
- **담당**: JIN
- **목적**: bbox 자동 보정을 통한 라벨링 품질 개선
- **결과**: ❌ 폐기 (자동 보정 한계로 원본 사용 결정)

## 배경
- 기존 bbox가 알약보다 10-70% 크게 설정됨
- train_batch 시각화에서 bbox > 알약 크기 확인
- tightness 측정 결과: 약 48% (이상적: 70%+)

## 시도한 방법들

### 방법 1: Otsu Thresholding
```python
gray = cv2.cvtColor(roi, cv2.COLOR_BGR2GRAY)
_, binary = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)
```

**결과:**
- 밝은 배경 + 밝은 알약: 실패
- 어두운 배경 + 어두운 알약: 실패
- 성공률: ~30%

### 방법 2: GrabCut 알고리즘
```python
cv2.grabCut(img, mask, rect, bgdModel, fgdModel, 5, cv2.GC_INIT_WITH_RECT)
fg_mask = np.where((mask == cv2.GC_FGD) | (mask == cv2.GC_PR_FGD), 255, 0)
```

**결과:**
- GMM 기반으로 Otsu보다 개선
- 하지만 여전히 실패 케이스 다수
- 성공률: ~50%

### 방법 3: shrink_bbox (고정 비율 축소)
```python
def shrink_bbox(bbox, ratio=0.15):
    # 중심 유지하며 15% 축소
```

**결과:**
- 단순하고 안정적
- 하지만 알약 크기와 무관하게 일괄 축소
- 정확도: 낮음

## 최신 논문/기술 조사

| 기술 | 출처 | 특징 | 적용 가능성 |
|------|------|------|-------------|
| SAM | Meta 2024 | 가장 정확한 segmentation | GPU 필요, 느림 |
| GrabCut | OpenCV | GMM 기반 분리 | 색상 유사시 실패 |
| NBBOX | arXiv 2024 | 노이즈 있는 bbox로 학습 | 보정 없이 사용 가능 |

**참고 링크:**
- [SAM 2 - Ultralytics](https://docs.ultralytics.com/models/sam-2/)
- [GrabCut for Object Detection](https://pmc.ncbi.nlm.nih.gov/articles/PMC9783755/)
- [NBBOX Paper](https://arxiv.org/html/2409.09424v1)

## 실패 원인 분석

### 1. 알약 이미지 특성
- 흰색/투명/반사 알약 → 배경과 구분 어려움
- 그림자가 알약 일부처럼 인식됨
- 알약 가장자리가 흐릿함

### 2. Combo 이미지 복잡성
- 여러 알약이 있으면 분리 더 어려움
- 각 알약별로 다른 색상/크기

### 3. 기존 라벨링 방식
- 원본 라벨러들도 "넉넉하게" 잡았을 가능성
- 의도된 마진일 수도 있음

## 결론

### 왜 폐기하는가?
1. **불안정한 보정**: 성공/실패 케이스가 섞여 일관성 깨짐
2. **YOLO 특성**: bbox 10-20% 크더라도 학습 가능
3. **일관성 > 정확성**: 모두 비슷하게 크면 모델이 적응

### 대안
- **원본 데이터 그대로 사용**
- bbox 보정 대신 효과적인 방법:
  - 데이터 증강 (Mosaic, Mixup, Copy-paste)
  - 클래스 밸런싱 (Oversampling)
  - 모델 업그레이드 (YOLOv8s → YOLOv8m)

---

## 관련 파일

### 수정된 파일
- `src/data/aihub/refine_coco_labels.py` - GrabCut 기반으로 리팩토링 (사용 안 함)
- `src/data/check_bbox_alignment.py` - 검증 도구 개선

### 시각화 결과
- `outputs/bbox_alignment_check/kaggle/` - bbox 시각화 이미지

---

## 교훈

> **"자동 보정보다 일관성이 중요하다"**
>
> YOLO는 bbox가 약간 크거나 작아도 학습 가능.
> 보정 실패로 일부만 바뀌면 오히려 해로움.
> 데이터 증강/클래스 밸런싱이 더 효과적.
