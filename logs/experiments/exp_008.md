# Experiment 008: imgsz 1280 + TTA 실험

## 개요

| 항목 | 내용 |
|------|------|
| 실험 ID | exp_008 |
| 날짜 | 2025-12-22 |
| 담당자 | 이진석 |
| 목표 | 작은 알약 검출 성능 향상 |
| 결과 | 실패 (성능 저하) |

---

## 가설

1. imgsz를 640 → 1280으로 키우면 작은 알약 검출 성능이 향상될 것
2. TTA를 적용하면 추론 정확도가 향상될 것
3. mAP@[0.75:0.95] 기준에서 개선이 있을 것

---

## 실험 설정

### Detector 학습 설정

```python
CONFIG = {
    "model": "yolo11m.pt",
    "data": "data/yolo/pills.yaml",
    "epochs": 50,
    "imgsz": 1280,  # 640 → 1280
    "batch": 2,     # 8 → 2 (메모리 절약)
    "patience": 15,
    "project": "runs/detect",
    "name": "yolo11m_detector_1280",
}
```

### TTA 설정

```python
det_results = self.detector.predict(
    image_path,
    augment=True,  # TTA 적용
    ...
)
```

---

## 실험 결과

### 학습 결과 (Validation)

| Metric | 값 |
|--------|-----|
| mAP50 | 0.986 |
| mAP50-95 | 0.83 |
| Precision | 0.991 |
| Recall | 0.996 |

### Kaggle 제출 결과

| Submission | 모델 | TTA | Score |
|------------|------|-----|-------|
| #6 (Baseline) | 640 | X | **0.96703** |
| #7 | 1280 | X | 0.713 |
| #8 | 1280 | O | 0.533 |

---

## 분석

### 실패 원인

1. **imgsz 불일치 가능성**
   - 학습: imgsz 1280
   - 추론: imgsz 미지정 (기본값 640?)
   - YOLO predict()에서 imgsz 명시 안 함

2. **bbox 정밀도 저하**
   - mAP50은 비슷하나 mAP@[0.75:0.95]에서 성능 저하
   - 높은 IoU 기준에서 bbox가 덜 정밀

3. **TTA 부작용**
   - 멀티스케일 + 반전 이미지가 bbox를 흐리게 만듦
   - NMS에서 중복 제거 시 정확한 bbox 손실

### 결론

- imgsz 1280은 현재 설정에서 효과 없음
- TTA도 mAP@[0.75:0.95] 기준에서는 오히려 해로움
- **기존 640 모델 유지 (Best Score 0.96703)**

---

## 개선 방안 (미적용)

1. 추론 시 `imgsz=1280` 명시
2. Classifier 성능 향상 (ConvNeXt → EfficientNet 앙상블)
3. bbox 후처리 정밀화
4. 더 정밀한 라벨링 데이터 확보

---

## 코드 변경

### 수정된 파일

1. `src/models/yolo11m_detector.py` - imgsz 1280, batch 2
2. `src/inference/pill_pipeline_v2.py` - use_tta 옵션 추가
3. `src/inference/submit_v2.py` - --tta 플래그 추가

### 복원된 설정

```python
# submit_v2.py - Best Score 재현용
detector_path: str = "runs/detect/yolo11m_detector/weights/best.pt"  # 640 모델
```

---

## 참고

- 대회 평가 기준: mAP@[0.75:0.95]
- IoU 0.75~0.95 범위에서 bbox 정밀도가 매우 중요
- 다른 팀 최고 점수: 0.99

---

## 태그

`#detector` `#imgsz` `#TTA` `#실패` `#분석`
