# Experiment 006: 2-Stage Pipeline (Detector + Classifier)

**날짜**: 2025-12-18
**결과**: 0.81544 → **0.96** (대폭 상승!)

---

## 배경

기존 접근법의 문제점:
- ROI 크롭된 이미지로 YOLO 학습 → bbox=[0,0,w,h]로 전체 이미지가 bbox
- 모델이 "이미지 전체 = 알약"으로 학습 → 배경 구분 불가
- mAP ≈ 0으로 학습 실패

## 해결: 2-Stage Pipeline

```
입력 이미지
    ↓
[Stage 1: Detector] → 알약 위치 검출 (단일 클래스 "Pill")
    ↓
각 bbox crop
    ↓
[Stage 2: Classifier] → 74개 클래스 분류
    ↓
최종 결과 (bbox + category_id + score)
```

---

## Stage 1: Pill Detector

### 데이터
- **Kaggle**: 232개 (원본 이미지 + bbox)
- **AIHub**: 5000개 (조합 이미지 + bbox)
- **총**: ~5200개 이미지

### 학습
- 모델: YOLO11s
- 클래스: 1개 (Pill)
- Early stopping 적용

### 스크립트
- `src/data/aihub/extract_for_detector.py` - AIHub 원본 이미지 추출
- `src/data/yolo_dataset/yolo_export_detector.py` - YOLO 데이터셋 생성
- `src/models/pill_detector.py` - Detector 학습

---

## Stage 2: Pill Classifier

### 데이터
- 크롭된 이미지 사용 (`data/cropped/`)
- 74개 클래스, 클래스당 ~200개

### 학습
- 모델: YOLO11s-cls (Classification 모드)
- Early stopping at epoch 21

### 스크립트
- `src/data/yolo_dataset/yolo_export_classifier.py` - Classification 폴더 구조 생성
- `src/models/pill_classifier.py` - Classifier 학습

---

## 시행착오 및 해결

### 1. 검출 누락 문제
**증상**: 843개 이미지 중 132개에서 알약 미검출
**원인**: detector_conf=0.25가 너무 높음
**해결**: detector_conf=0.05로 낮춤 → 모든 이미지에서 검출 성공

### 2. category_id 변환 오류 (치명적!)
**증상**:
```
category_id: 1, 24, 11, 69  (YOLO index)
예상값: 27925, 16550, 24849, 1899  (dl_idx)
```

**원인**:
- YOLO classifier의 class names가 폴더명(K-code)으로 저장됨
- 하지만 class_mapping.json 로드 방식이 잘못됨

**해결**:
```python
# pill_pipeline.py
if hasattr(self.classifier, 'names') and top1_idx in self.classifier.names:
    k_code = self.classifier.names[top1_idx]  # YOLO 모델의 names 직접 사용
```

### 3. Score 계산
**시도**: `score = detector_conf × classifier_conf`
**문제**: det_conf=0.05면 score가 너무 낮아짐
**해결**: `score = classifier_conf` (classifier confidence만 사용)

### 4. Submission 형식
**기존 (잘못됨)**:
```
image_id,class
1,27925
```

**정답 형식**:
```
annotation_id,image_id,category_id,bbox_x,bbox_y,bbox_w,bbox_h,score
1,1,27925,558,73,394,403,0.95
```

---

## 최종 결과

| 항목 | 기존 (11s_aug) | 2-Stage Pipeline |
|------|---------------|------------------|
| 점수 | 0.81544 | **0.96** |
| 검출 수 | 3108 | 3400+ |
| 방식 | End-to-end | Detector + Classifier |

---

## 핵심 파일

```
src/
├── data/
│   ├── aihub/
│   │   └── extract_for_detector.py    # AIHub 원본 추출
│   └── yolo_dataset/
│       ├── yolo_export_detector.py    # Detector 데이터셋
│       └── yolo_export_classifier.py  # Classifier 데이터셋
├── models/
│   ├── pill_detector.py               # Stage 1 학습
│   └── pill_classifier.py             # Stage 2 학습
└── inference/
    ├── pill_pipeline.py               # 2-Stage 파이프라인
    └── submit.py                      # Kaggle 제출용 배치 추론
```

---

## 학습된 모델

- Detector: `runs/detect/pill_detector/weights/best.pt`
- Classifier: `runs/classify/pill_classifier/weights/best.pt`
- 클래스 매핑: `data/yolo_cls/class_mapping.json`

---

## 실행 명령어

```bash
# 추론 및 제출 파일 생성
python -m src.inference.submit --det_conf 0.05 --output submission.csv
```

---

## 교훈

1. **2-Stage 분리의 효과**: Detection과 Classification을 분리하면 각각 최적화 가능
2. **데이터 형식 확인 필수**: YOLO 모델의 class names 형식 반드시 확인
3. **Submission 형식 정확히 맞추기**: category_id 변환 오류로 점수 0.81 → 0.96 차이 발생
4. **Threshold 튜닝**: detector_conf를 낮춰서 recall 확보 후, classifier로 정제
