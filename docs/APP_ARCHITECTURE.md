# 📐 Health Eat - 앱 아키텍처 설계도

> **Version 2.0** | 2025-12-18 | **Cloud Architecture**

---

## 📋 목차

1. [전체 시스템 아키텍처](#1-전체-시스템-아키텍처)
2. [사용자 플로우 (UX)](#2-사용자-플로우-ux)
3. [AI 파이프라인 상세](#3-ai-파이프라인-상세)
4. [백엔드 서버 구조](#4-백엔드-서버-구조)
5. [모바일 앱 구조](#5-모바일-앱-구조)
6. [데이터베이스 스키마](#6-데이터베이스-스키마)
7. [REST API 설계](#7-rest-api-설계)
8. [기술 스택](#8-기술-스택)

---

## 1. 전체 시스템 아키텍처

### 1.1 High-Level Architecture (Cloud)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Health Eat System (Cloud)                               │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│                              ┌─────────────┐                                        │
│                              │   📱 User   │                                        │
│                              │   Device    │                                        │
│                              └──────┬──────┘                                        │
│                                     │                                               │
│                                     │ 사진 촬영                                      │
│                                     ▼                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                           Mobile Application                                 │  │
│   │   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐              │  │
│   │   │  Camera   │  │   API     │  │  Result   │  │  Detail   │              │  │
│   │   │  Module   │  │  Client   │  │  Display  │  │  Screen   │              │  │
│   │   └─────┬─────┘  └─────┬─────┘  └───────────┘  └───────────┘              │  │
│   └─────────┼──────────────┼────────────────────────────────────────────────────┘  │
│             │              │                                                        │
│             │              │  HTTPS (REST API)                                      │
│             │              ▼                                                        │
│   ══════════╪══════════════╪════════════════════════════════════════════════════   │
│             │              │          ☁️ CLOUD                                      │
│   ══════════╪══════════════╪════════════════════════════════════════════════════   │
│             │              │                                                        │
│             │              ▼                                                        │
│             │    ┌─────────────────┐                                               │
│             │    │   API Gateway   │                                               │
│             │    │   (Load Balancer)│                                               │
│             │    └────────┬────────┘                                               │
│             │             │                                                        │
│             │    ┌────────┴────────┐                                               │
│             │    ▼                 ▼                                               │
│             │  ┌─────────────┐  ┌─────────────┐                                    │
│             │  │  API Server │  │  AI Server  │                                    │
│             │  │  (FastAPI)  │  │  (PyTorch)  │                                    │
│             │  └──────┬──────┘  └──────┬──────┘                                    │
│             │         │                │                                           │
│             │         │    ┌───────────┘                                           │
│             │         ▼    ▼                                                       │
│             │    ┌─────────────┐                                                   │
│             │    │  Database   │                                                   │
│             │    │ (PostgreSQL)│                                                   │
│             │    └─────────────┘                                                   │
│             │                                                                      │
└─────────────┴──────────────────────────────────────────────────────────────────────┘
```

### 1.2 Cloud Architecture 선택 이유

| 항목 | On-Device | Cloud (선택) |
|:----:|:---------:|:------------:|
| 모델 크기 | ⚠️ 제한 (~50MB) | ✅ **제한 없음** |
| 모델 업데이트 | ⚠️ 앱 업데이트 필요 | ✅ **서버만 수정** |
| 모델 성능 | ⚠️ 경량화 필요 | ✅ **풀 모델 사용** |
| 앱 크기 | ⚠️ 큼 (~100MB) | ✅ **작음 (~20MB)** |
| 기기 호환성 | ⚠️ 고사양 필요 | ✅ **저사양도 OK** |
| 오프라인 | ✅ 지원 | ❌ 불가 |
| 속도 | ✅ 빠름 | 🔺 네트워크 의존 |

> **결정**: Cloud 방식 채택
> - 프라이버시 민감도 낮음 (알약 사진만 전송)
> - 모델 업데이트/개선 용이
> - 앱 경량화로 사용자 접근성 향상

### 1.3 인프라 구성

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Cloud Infrastructure                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   Option A: AWS                        Option B: GCP                            │
│   ─────────────                        ───────────────                          │
│                                                                                 │
│   ┌─────────────────┐                  ┌─────────────────┐                     │
│   │  EC2 / ECS      │                  │  Cloud Run      │                     │
│   │  (API Server)   │                  │  (API Server)   │                     │
│   └─────────────────┘                  └─────────────────┘                     │
│                                                                                 │
│   ┌─────────────────┐                  ┌─────────────────┐                     │
│   │  EC2 + GPU      │                  │  Vertex AI      │                     │
│   │  (AI Server)    │                  │  (AI Server)    │                     │
│   └─────────────────┘                  └─────────────────┘                     │
│                                                                                 │
│   ┌─────────────────┐                  ┌─────────────────┐                     │
│   │  RDS            │                  │  Cloud SQL      │                     │
│   │  (PostgreSQL)   │                  │  (PostgreSQL)   │                     │
│   └─────────────────┘                  └─────────────────┘                     │
│                                                                                 │
│   ┌─────────────────┐                  ┌─────────────────┐                     │
│   │  S3             │                  │  Cloud Storage  │                     │
│   │  (Image Storage)│                  │  (Image Storage)│                     │
│   └─────────────────┘                  └─────────────────┘                     │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 사용자 플로우 (UX)

### 2.1 메인 플로우

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              사용자 플로우                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
    │  앱     │     │  카메라 │     │  서버   │     │  결과   │     │  상세   │
    │  실행   │ ──▶ │  촬영   │ ──▶ │  분석   │ ──▶ │  확인   │ ──▶ │  정보   │
    └─────────┘     └─────────┘     └─────────┘     └─────────┘     └─────────┘
         │               │               │               │               │
         ▼               ▼               ▼               ▼               ▼
    ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
    │ 홈 화면 │     │ 사진    │     │ API     │     │ 알약    │     │ 효능    │
    │         │     │ 촬영    │     │ 호출    │     │ 목록    │     │ 주의점  │
    │ [촬영]  │     │  ↓      │     │ (1~3초) │     │ 표시    │     │ 상호작용│
    │         │     │ 업로드  │     │         │     │         │     │         │
    └─────────┘     └─────────┘     └─────────┘     └─────────┘     └─────────┘
```

### 2.2 화면별 상세

#### 📱 Screen 1: 홈 화면

```
┌─────────────────────────────────┐
│  Health Eat              ⚙️     │
├─────────────────────────────────┤
│                                 │
│                                 │
│        ┌───────────────┐        │
│        │               │        │
│        │      📷       │        │
│        │               │        │
│        │   알약 촬영   │        │
│        │               │        │
│        └───────────────┘        │
│                                 │
│                                 │
│  💡 최대 4개 알약까지 인식      │
│                                 │
├─────────────────────────────────┤
│  📋 최근 검색 기록              │
│  ├─ 타이레놀 500mg (12/18)     │
│  └─ 아스피린 100mg (12/17)     │
└─────────────────────────────────┘
```

#### 📱 Screen 2: 카메라 화면

```
┌─────────────────────────────────┐
│  ←                        ❓    │
├─────────────────────────────────┤
│                                 │
│  ┌─────────────────────────┐   │
│  │                         │   │
│  │     ┌─────┐ ┌─────┐     │   │
│  │     │ 💊 │ │ 💊 │     │   │
│  │     └─────┘ └─────┘     │   │
│  │                         │   │
│  │     ┌─────┐             │   │
│  │     │ 💊 │             │   │
│  │     └─────┘             │   │
│  │                         │   │
│  └─────────────────────────┘   │
│                                 │
│  💡 알약이 겹치지 않게 배치     │
│                                 │
│         ┌───────────┐           │
│         │    📸     │           │
│         │   촬영    │           │
│         └───────────┘           │
└─────────────────────────────────┘
```

#### 📱 Screen 3: 분석 중 (서버 처리)

```
┌─────────────────────────────────┐
│                                 │
│                                 │
│                                 │
│            ☁️⏳                  │
│                                 │
│      서버에서 분석 중...        │
│                                 │
│         ████████░░ 80%         │
│                                 │
│   💡 네트워크 연결을 확인하세요 │
│                                 │
└─────────────────────────────────┘
```

#### 📱 Screen 4: 결과 화면 (정상)

```
┌─────────────────────────────────┐
│  ←  분석 결과              🔄   │
├─────────────────────────────────┤
│                                 │
│  ✅ 3개 알약 인식됨             │
│                                 │
│  ┌─────────────────────────┐   │
│  │ 💊 타이레놀 500mg       │   │
│  │    해열/진통제          │   │
│  │    신뢰도: 96%     [>]  │   │
│  └─────────────────────────┘   │
│                                 │
│  ┌─────────────────────────┐   │
│  │ 💊 아스피린 100mg       │   │
│  │    소염/진통제          │   │
│  │    신뢰도: 94%     [>]  │   │
│  └─────────────────────────┘   │
│                                 │
│  ┌─────────────────────────┐   │
│  │ 💊 오메프라졸 20mg      │   │
│  │    위산억제제           │   │
│  │    신뢰도: 91%     [>]  │   │
│  └─────────────────────────┘   │
│                                 │
│  ⚠️ 상호작용 주의 (1건)         │
│  ┌─────────────────────────┐   │
│  │ 타이레놀 + 아스피린      │   │
│  │ 함께 복용 시 위장 출혈   │   │
│  │ 위험 증가              [>]│   │
│  └─────────────────────────┘   │
│                                 │
└─────────────────────────────────┘
```

#### 📱 Screen 5: 결과 화면 (불확실)

```
┌─────────────────────────────────┐
│  ←  분석 결과              🔄   │
├─────────────────────────────────┤
│                                 │
│  ⚠️ 일부 알약 확인 필요         │
│                                 │
│  ┌─────────────────────────┐   │
│  │ 💊 타이레놀 500mg       │   │
│  │    해열/진통제          │   │
│  │    신뢰도: 96%     [>]  │   │
│  └─────────────────────────┘   │
│                                 │
│  ┌─────────────────────────┐   │
│  │ ⚠️ 확인 필요            │   │
│  │    신뢰도: 78%          │   │
│  │                         │   │
│  │  이 약이 맞나요?        │   │
│  │  ┌─────┐ ┌─────────┐   │   │
│  │  │ 아님│ │ 맞아요 ✓│   │   │
│  │  └─────┘ └─────────┘   │   │
│  │                         │   │
│  │  💡 더 밝은 곳에서      │   │
│  │     다시 촬영해보세요   │   │
│  └─────────────────────────┘   │
│                                 │
└─────────────────────────────────┘
```

#### 📱 Screen 6: 결과 화면 (인식 불가)

```
┌─────────────────────────────────┐
│  ←  분석 결과              🔄   │
├─────────────────────────────────┤
│                                 │
│  ❌ 인식할 수 없는 알약         │
│                                 │
│  ┌─────────────────────────┐   │
│  │                         │   │
│  │         ❓              │   │
│  │                         │   │
│  │  이 알약을 인식할 수    │   │
│  │  없습니다.              │   │
│  │                         │   │
│  │  신뢰도: 45%            │   │
│  │                         │   │
│  └─────────────────────────┘   │
│                                 │
│  💡 촬영 팁:                    │
│  • 밝은 조명 아래서 촬영        │
│  • 알약 정면이 보이게           │
│  • 그림자 없이 촬영             │
│                                 │
│  ───────────────────────────   │
│                                 │
│  📞 약사에게 문의하기      [>]  │
│                                 │
│         ┌───────────┐           │
│         │  다시 촬영 │           │
│         └───────────┘           │
└─────────────────────────────────┘
```

#### 📱 Screen 7: 상세 정보 화면

```
┌─────────────────────────────────┐
│  ←  타이레놀 500mg              │
├─────────────────────────────────┤
│                                 │
│  ┌─────────────────────────┐   │
│  │         💊              │   │
│  │    [알약 이미지]        │   │
│  └─────────────────────────┘   │
│                                 │
│  📋 기본 정보                   │
│  ├─ 성분: 아세트아미노펜        │
│  ├─ 분류: 해열진통제            │
│  └─ 제조사: 한국존슨앤드존슨    │
│                                 │
│  ───────────────────────────   │
│                                 │
│  💊 효능/효과                   │
│  감기로 인한 발열 및 동통,      │
│  두통, 신경통, 근육통, 월경통,  │
│  염좌통의 완화                  │
│                                 │
│  ───────────────────────────   │
│                                 │
│  ⚠️ 복용 시 주의사항            │
│  • 1일 4g 초과 금지             │
│  • 음주 시 간 손상 위험         │
│  • 공복 복용 피할 것            │
│                                 │
│  ───────────────────────────   │
│                                 │
│  🔄 상호작용                    │
│  ┌─────────────────────────┐   │
│  │ ⚠️ 아스피린              │   │
│  │    위장 출혈 위험 증가   │   │
│  └─────────────────────────┘   │
│  ┌─────────────────────────┐   │
│  │ ⚠️ 와파린                │   │
│  │    출혈 위험 증가        │   │
│  └─────────────────────────┘   │
│                                 │
└─────────────────────────────────┘
```

#### 📱 Screen 8: 네트워크 오류

```
┌─────────────────────────────────┐
│  ←  오류                        │
├─────────────────────────────────┤
│                                 │
│                                 │
│                                 │
│            📡❌                 │
│                                 │
│     네트워크 연결을 확인하세요  │
│                                 │
│     인터넷 연결이 필요합니다    │
│                                 │
│                                 │
│         ┌───────────┐           │
│         │  다시 시도 │           │
│         └───────────┘           │
│                                 │
│                                 │
└─────────────────────────────────┘
```

---

## 3. AI 파이프라인 상세

### 3.1 2-Stage Pipeline (Server-Side)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           AI Pipeline (Cloud Server)                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   Client                  API Server               AI Server                    │
│   ──────                  ──────────               ─────────                    │
│                                                                                 │
│  ┌─────────┐            ┌─────────────┐          ┌─────────────────────────┐   │
│  │         │   HTTP     │             │  gRPC    │                         │   │
│  │  📸     │   POST     │   FastAPI   │   ───▶   │      AI Engine          │   │
│  │ Image   │   ───▶     │   Server    │          │                         │   │
│  │         │            │             │          │  ┌─────────────────┐    │   │
│  │ 1280    │            │  • 이미지   │          │  │   YOLO11s       │    │   │
│  │ x720    │            │    검증     │          │  │   Detector      │    │   │
│  │         │            │  • 전처리   │          │  │   (PyTorch)     │    │   │
│  └─────────┘            │  • 응답     │          │  └────────┬────────┘    │   │
│                         │    포맷팅   │          │           │             │   │
│                         └─────────────┘          │           ▼             │   │
│                                                  │  ┌─────────────────┐    │   │
│                                                  │  │   YOLO11s-cls   │    │   │
│                                                  │  │   Classifier    │    │   │
│                                                  │  │   (PyTorch)     │    │   │
│                                                  │  └────────┬────────┘    │   │
│                                                  │           │             │   │
│                                                  │           ▼             │   │
│                                                  │  ┌─────────────────┐    │   │
│                                                  │  │   Drug Info     │    │   │
│                                                  │  │   Lookup        │    │   │
│                                                  │  │   (PostgreSQL)  │    │   │
│                                                  │  └─────────────────┘    │   │
│                                                  │                         │   │
│                                                  └─────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 처리 흐름 상세

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Request/Response Flow                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   1. 이미지 업로드                                                               │
│   ─────────────────                                                             │
│   Client ─────▶ POST /api/v1/analyze                                            │
│                 Body: { image: base64 }                                         │
│                                                                                 │
│   2. 이미지 검증 & 전처리                                                        │
│   ───────────────────────                                                       │
│   API Server:                                                                   │
│   • 이미지 포맷 검증 (JPEG, PNG)                                                 │
│   • 이미지 크기 검증 (< 10MB)                                                    │
│   • 리사이즈 (1280x720)                                                         │
│                                                                                 │
│   3. AI 추론 (Stage 1: Detection)                                               │
│   ─────────────────────────────                                                 │
│   AI Server:                                                                    │
│   • YOLO11s Detector 실행                                                       │
│   • BBox 검출 (최대 4개)                                                         │
│   • Output: [{ bbox, det_conf }, ...]                                           │
│                                                                                 │
│   4. AI 추론 (Stage 2: Classification)                                          │
│   ────────────────────────────────────                                          │
│   AI Server:                                                                    │
│   • 각 BBox 크롭                                                                 │
│   • YOLO11s-cls Classifier 실행                                                 │
│   • Output: [{ k_code, cls_conf }, ...]                                         │
│                                                                                 │
│   5. 약물 정보 조회                                                              │
│   ─────────────────                                                             │
│   API Server:                                                                   │
│   • K-code로 DB 조회                                                            │
│   • 상호작용 체크                                                                │
│                                                                                 │
│   6. 응답 반환                                                                   │
│   ────────────                                                                  │
│   Client ◀───── { pills: [...], interactions: [...] }                           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Confidence 기반 분기 처리

```
                              ┌─────────────────┐
                              │   Classifier    │
                              │   Output        │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  Confidence     │
                              │  Score (0~1)    │
                              └────────┬────────┘
                                       │
                 ┌─────────────────────┼─────────────────────┐
                 │                     │                     │
                 ▼                     ▼                     ▼
          conf ≥ 0.9            0.7 ≤ conf < 0.9       conf < 0.7
                 │                     │                     │
                 ▼                     ▼                     ▼
        ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
        │                 │   │                 │   │                 │
        │  ✅ CONFIRMED   │   │  ⚠️ UNCERTAIN   │   │  ❌ UNKNOWN     │
        │                 │   │                 │   │                 │
        │  약물 정보      │   │  "이 약이       │   │  "인식할 수    │
        │  바로 표시      │   │   맞나요?"      │   │   없습니다"    │
        │                 │   │                 │   │                 │
        │                 │   │  + 재촬영 안내  │   │  + 약사 문의   │
        │                 │   │                 │   │    안내        │
        └─────────────────┘   └─────────────────┘   └─────────────────┘
```

---

## 4. 백엔드 서버 구조

### 4.1 서버 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Backend Architecture                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │                           API Server (FastAPI)                           │  │
│   │                                                                         │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │  │
│   │  │   Routes    │  │   Services  │  │    Models   │  │   Schemas   │   │  │
│   │  │             │  │             │  │             │  │             │   │  │
│   │  │ /analyze    │  │ PillService │  │ Drug        │  │ AnalyzeReq  │   │  │
│   │  │ /drugs      │  │ DrugService │  │ Interaction │  │ AnalyzeRes  │   │  │
│   │  │ /interact   │  │ AIService   │  │ History     │  │ DrugInfo    │   │  │
│   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │  │
│   │                                                                         │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                          │                                      │
│                                          ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │                           AI Server (PyTorch)                            │  │
│   │                                                                         │  │
│   │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │  │
│   │  │   Detector      │  │   Classifier    │  │   Preprocessor  │        │  │
│   │  │   (YOLO11s)     │  │   (YOLO11s-cls) │  │                 │        │  │
│   │  │                 │  │                 │  │  • Resize       │        │  │
│   │  │  • GPU 추론     │  │  • GPU 추론     │  │  • Normalize    │        │  │
│   │  │  • BBox 검출    │  │  • 74 Classes   │  │  • Augment      │        │  │
│   │  └─────────────────┘  └─────────────────┘  └─────────────────┘        │  │
│   │                                                                         │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                          │                                      │
│                                          ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │                           Database (PostgreSQL)                          │  │
│   │                                                                         │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │  │
│   │  │   drugs     │  │ interactions│  │   users     │  │  history    │   │  │
│   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │  │
│   │                                                                         │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 디렉토리 구조 (Backend)

```
health-eat-backend/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI entry point
│   ├── config.py               # 설정
│   │
│   ├── api/
│   │   ├── __init__.py
│   │   ├── routes/
│   │   │   ├── analyze.py      # POST /analyze
│   │   │   ├── drugs.py        # GET /drugs
│   │   │   └── interactions.py # GET /interactions
│   │   └── deps.py             # Dependencies
│   │
│   ├── services/
│   │   ├── __init__.py
│   │   ├── pill_service.py     # AI 파이프라인
│   │   ├── drug_service.py     # 약물 정보 조회
│   │   └── ai_service.py       # 모델 추론
│   │
│   ├── models/
│   │   ├── __init__.py
│   │   ├── drug.py             # Drug ORM
│   │   └── interaction.py      # Interaction ORM
│   │
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── analyze.py          # Request/Response
│   │   └── drug.py             # Drug schemas
│   │
│   └── ml/
│       ├── __init__.py
│       ├── detector.py         # YOLO Detector
│       ├── classifier.py       # YOLO Classifier
│       └── models/
│           ├── yolo11s.pt
│           └── yolo11s-cls.pt
│
├── tests/
├── requirements.txt
├── Dockerfile
└── docker-compose.yml
```

---

## 5. 모바일 앱 구조

### 5.1 Module Structure (경량화)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Mobile App Architecture (Thin Client)                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │                        Presentation Layer                                │  │
│   │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐            │  │
│   │  │   Home    │  │  Camera   │  │  Result   │  │  Detail   │            │  │
│   │  │  Screen   │  │  Screen   │  │  Screen   │  │  Screen   │            │  │
│   │  └───────────┘  └───────────┘  └───────────┘  └───────────┘            │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │                         Business Layer                                   │  │
│   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐               │  │
│   │  │  API Client   │  │  Image        │  │  Local        │               │  │
│   │  │  (Retrofit)   │  │  Handler      │  │  Cache        │               │  │
│   │  └───────────────┘  └───────────────┘  └───────────────┘               │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │                           Data Layer                                     │  │
│   │  ┌───────────────┐  ┌───────────────┐                                   │  │
│   │  │  Network      │  │  SharedPrefs  │   ❌ No Local DB                  │  │
│   │  │  (OkHttp)     │  │  (검색기록)   │   ❌ No AI Model                  │  │
│   │  └───────────────┘  └───────────────┘                                   │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│   📦 앱 크기: ~15-20MB (기존 ~100MB에서 대폭 감소)                              │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 주요 컴포넌트

| Layer | Component | 역할 |
|:-----:|-----------|------|
| **Presentation** | HomeScreen | 메인 화면, 촬영 버튼 |
| | CameraScreen | 카메라 프리뷰, 촬영 |
| | ResultScreen | 인식 결과 표시 |
| | DetailScreen | 약물 상세 정보 |
| | ErrorScreen | 네트워크 오류 처리 |
| **Business** | APIClient | 서버 통신 (Retrofit) |
| | ImageHandler | 이미지 압축/인코딩 |
| | LocalCache | 검색 기록 캐싱 |
| **Data** | NetworkModule | HTTP 클라이언트 |
| | SharedPrefs | 로컬 저장소 |

---

## 6. 데이터베이스 스키마

### 6.1 ERD (Entity Relationship Diagram)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Database Schema (PostgreSQL)                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌───────────────────┐         ┌───────────────────┐                          │
│   │      drugs        │         │   interactions    │                          │
│   ├───────────────────┤         ├───────────────────┤                          │
│   │ PK  drug_id       │────┐    │ PK  interaction_id│                          │
│   │     k_code        │    │    │ FK  drug_id_1     │──┐                       │
│   │     name_kr       │    └───▶│ FK  drug_id_2     │──┘                       │
│   │     name_en       │         │     severity      │                          │
│   │     ingredient    │         │     description   │                          │
│   │     efficacy      │         │     created_at    │                          │
│   │     dosage        │         └───────────────────┘                          │
│   │     caution       │                                                         │
│   │     side_effect   │         ┌───────────────────┐                          │
│   │     manufacturer  │         │      users        │                          │
│   │     image_url     │         ├───────────────────┤                          │
│   │     shape         │         │ PK  user_id       │                          │
│   │     color         │         │     device_id     │                          │
│   │     created_at    │         │     created_at    │                          │
│   └───────────────────┘         └─────────┬─────────┘                          │
│                                           │                                     │
│                                           │                                     │
│                                           ▼                                     │
│                                 ┌───────────────────┐                          │
│                                 │  analysis_history │                          │
│                                 ├───────────────────┤                          │
│                                 │ PK  history_id    │                          │
│                                 │ FK  user_id       │                          │
│                                 │     image_url     │                          │
│                                 │     results_json  │                          │
│                                 │     analyzed_at   │                          │
│                                 └───────────────────┘                          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 테이블 정의

```sql
-- 약물 정보
CREATE TABLE drugs (
    drug_id       SERIAL PRIMARY KEY,
    k_code        VARCHAR(20) UNIQUE NOT NULL,
    name_kr       VARCHAR(200) NOT NULL,
    name_en       VARCHAR(200),
    ingredient    TEXT NOT NULL,
    efficacy      TEXT,
    dosage        TEXT,
    caution       TEXT,
    side_effect   TEXT,
    manufacturer  VARCHAR(100),
    shape         VARCHAR(50),
    color         VARCHAR(50),
    image_url     TEXT,
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 상호작용 정보
CREATE TABLE interactions (
    interaction_id  SERIAL PRIMARY KEY,
    drug_id_1       INTEGER NOT NULL REFERENCES drugs(drug_id),
    drug_id_2       INTEGER NOT NULL REFERENCES drugs(drug_id),
    severity        VARCHAR(10) NOT NULL CHECK (severity IN ('high', 'medium', 'low')),
    description     TEXT NOT NULL,
    recommendation  TEXT,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 사용자 (익명)
CREATE TABLE users (
    user_id     SERIAL PRIMARY KEY,
    device_id   VARCHAR(100) UNIQUE NOT NULL,
    created_at  TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 분석 기록
CREATE TABLE analysis_history (
    history_id    SERIAL PRIMARY KEY,
    user_id       INTEGER REFERENCES users(user_id),
    image_url     TEXT,
    results_json  JSONB,
    analyzed_at   TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_drugs_k_code ON drugs(k_code);
CREATE INDEX idx_interactions_drug1 ON interactions(drug_id_1);
CREATE INDEX idx_interactions_drug2 ON interactions(drug_id_2);
CREATE INDEX idx_history_user ON analysis_history(user_id);
```

---

## 7. REST API 설계

### 7.1 API 엔드포인트

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              REST API Endpoints                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   Base URL: https://api.healtheat.com/v1                                        │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │  POST /analyze                                                           │  │
│   │  ─────────────                                                           │  │
│   │  알약 이미지 분석 (핵심 API)                                              │  │
│   │                                                                         │  │
│   │  Request:                                                               │  │
│   │  {                                                                      │  │
│   │      "image": "base64_encoded_string",                                  │  │
│   │      "device_id": "uuid" (optional)                                     │  │
│   │  }                                                                      │  │
│   │                                                                         │  │
│   │  Response (200 OK):                                                     │  │
│   │  {                                                                      │  │
│   │      "status": "success",                                               │  │
│   │      "analysis_id": "uuid",                                             │  │
│   │      "pills": [                                                         │  │
│   │          {                                                              │  │
│   │              "k_code": "K-001234",                                      │  │
│   │              "name": "타이레놀 500mg",                                   │  │
│   │              "confidence": 0.96,                                        │  │
│   │              "status": "CONFIRMED",  // CONFIRMED|UNCERTAIN|UNKNOWN     │  │
│   │              "bbox": {"x": 100, "y": 200, "w": 50, "h": 50},            │  │
│   │              "drug_info": {                                             │  │
│   │                  "ingredient": "아세트아미노펜",                         │  │
│   │                  "efficacy": "해열, 진통",                               │  │
│   │                  "caution": "1일 4g 초과 금지"                           │  │
│   │              }                                                          │  │
│   │          }                                                              │  │
│   │      ],                                                                 │  │
│   │      "interactions": [                                                  │  │
│   │          {                                                              │  │
│   │              "drug1": "타이레놀 500mg",                                  │  │
│   │              "drug2": "아스피린 100mg",                                  │  │
│   │              "severity": "high",                                        │  │
│   │              "description": "위장 출혈 위험 증가"                        │  │
│   │          }                                                              │  │
│   │      ]                                                                  │  │
│   │  }                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │  GET /drugs/{k_code}                                                     │  │
│   │  ────────────────────                                                    │  │
│   │  특정 약물 상세 정보 조회                                                 │  │
│   │                                                                         │  │
│   │  Response (200 OK):                                                     │  │
│   │  {                                                                      │  │
│   │      "k_code": "K-001234",                                              │  │
│   │      "name_kr": "타이레놀 500mg",                                        │  │
│   │      "name_en": "Tylenol 500mg",                                        │  │
│   │      "ingredient": "아세트아미노펜",                                     │  │
│   │      "efficacy": "발열, 두통, 신경통 완화",                               │  │
│   │      "dosage": "1회 1~2정, 1일 3~4회",                                   │  │
│   │      "caution": "1일 4g 초과 금지, 음주 시 간 손상",                      │  │
│   │      "side_effect": "구역, 구토, 식욕부진",                               │  │
│   │      "manufacturer": "한국존슨앤드존슨",                                  │  │
│   │      "image_url": "https://..."                                         │  │
│   │  }                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │  GET /interactions?drugs=K-001234,K-002345                               │  │
│   │  ─────────────────────────────────────────                               │  │
│   │  여러 약물 간 상호작용 조회                                               │  │
│   │                                                                         │  │
│   │  Response (200 OK):                                                     │  │
│   │  {                                                                      │  │
│   │      "interactions": [                                                  │  │
│   │          {                                                              │  │
│   │              "drug1": { "k_code": "K-001234", "name": "..." },          │  │
│   │              "drug2": { "k_code": "K-002345", "name": "..." },          │  │
│   │              "severity": "high",                                        │  │
│   │              "description": "...",                                      │  │
│   │              "recommendation": "..."                                    │  │
│   │          }                                                              │  │
│   │      ]                                                                  │  │
│   │  }                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │  GET /health                                                             │  │
│   │  ────────────                                                            │  │
│   │  서버 상태 확인                                                           │  │
│   │                                                                         │  │
│   │  Response (200 OK):                                                     │  │
│   │  { "status": "healthy", "version": "1.0.0" }                            │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 에러 응답

```json
// 400 Bad Request
{
    "status": "error",
    "error_code": "INVALID_IMAGE",
    "message": "이미지 형식이 올바르지 않습니다."
}

// 404 Not Found
{
    "status": "error",
    "error_code": "DRUG_NOT_FOUND",
    "message": "해당 약물 정보를 찾을 수 없습니다."
}

// 500 Internal Server Error
{
    "status": "error",
    "error_code": "ANALYSIS_FAILED",
    "message": "분석 중 오류가 발생했습니다."
}
```

---

## 8. 기술 스택

### 8.1 전체 스택

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Technology Stack (Cloud)                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   📱 Mobile App (Client)                                                        │
│   ──────────────────────                                                        │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│   │  Kotlin     │  │  Jetpack    │  │  Retrofit   │  │  CameraX    │          │
│   │  (Android)  │  │  Compose    │  │  (HTTP)     │  │             │          │
│   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                                                 │
│   🖥️ Backend Server                                                             │
│   ─────────────────                                                             │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│   │  Python     │  │  FastAPI    │  │  SQLAlchemy │  │  Pydantic   │          │
│   │  3.10+      │  │             │  │  (ORM)      │  │  (Valid)    │          │
│   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                                                 │
│   🤖 AI Server                                                                  │
│   ────────────                                                                  │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│   │  PyTorch    │  │  YOLO11     │  │  CUDA       │  │  NumPy      │          │
│   │  2.0+       │  │  (Ultra)    │  │  (GPU)      │  │  OpenCV     │          │
│   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                                                 │
│   🗄️ Database                                                                   │
│   ───────────                                                                   │
│   ┌─────────────┐  ┌─────────────┐                                             │
│   │ PostgreSQL  │  │   Redis     │                                             │
│   │  (Main DB)  │  │  (Cache)    │                                             │
│   └─────────────┘  └─────────────┘                                             │
│                                                                                 │
│   ☁️ Infrastructure                                                             │
│   ─────────────────                                                             │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│   │  Docker     │  │  AWS/GCP    │  │  Nginx      │  │  GitHub     │          │
│   │  Compose    │  │             │  │  (Proxy)    │  │  Actions    │          │
│   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 버전 정보

| Category | Technology | Version | Purpose |
|:--------:|------------|:-------:|---------|
| **Mobile** | Kotlin | 1.9+ | 앱 개발 |
| | Jetpack Compose | 1.5+ | UI |
| | Retrofit | 2.9+ | HTTP Client |
| | CameraX | 1.3+ | 카메라 |
| **Backend** | Python | 3.10+ | 서버 언어 |
| | FastAPI | 0.100+ | API Framework |
| | SQLAlchemy | 2.0+ | ORM |
| | Pydantic | 2.0+ | 검증 |
| **AI** | PyTorch | 2.0+ | 딥러닝 |
| | Ultralytics | 8.0+ | YOLO |
| | CUDA | 11.8+ | GPU |
| **Database** | PostgreSQL | 15+ | Main DB |
| | Redis | 7+ | Cache |
| **Infra** | Docker | 24+ | 컨테이너 |
| | Nginx | 1.24+ | 리버스 프록시 |

---

## 📎 부록

### A. 성능 목표

| 지표 | 목표 | 비고 |
|:----:|:----:|------|
| API 응답 시간 | < 3초 | 이미지 분석 포함 |
| 앱 크기 | < 20MB | 모델 없음 |
| 동시 접속 | 100+ | 초기 목표 |
| 정확도 | ≥ 90% | Confidence ≥ 0.9 |
| 가용성 | 99.9% | SLA 목표 |

### B. 배포 구성 (Docker Compose)

```yaml
version: '3.8'
services:
  api:
    build: ./api
    ports:
      - "8000:8000"
    depends_on:
      - db
      - ai
    environment:
      - DATABASE_URL=postgresql://...

  ai:
    build: ./ai
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  db:
    image: postgres:15
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7

volumes:
  pgdata:
```

---

<div align="center">

**Health Eat - App Architecture v2.0 (Cloud)**

*2025-12-18*

</div>
