# Health Eat 프로젝트 타임라인

## 프로젝트 개요

| 항목 | 내용 |
|------|------|
| **프로젝트명** | Health Eat - AI 알약 인식 |
| **기간** | 2025.12.04 ~ 12.23 (약 3주) |
| **목표** | Kaggle mAP@[0.75:0.95] 경쟁 |
| **최종 결과** | **0.96703** (Baseline 대비 +18.7%) |

---

## Phase 1: 프로젝트 셋업 (12/04 ~ 12/05)

### 주요 작업
- 프로젝트 구조 초기화
- 팀 역할 배정
- 협업 워크플로우 수립

### 팀 구성
| 역할 | 담당자 |
|------|--------|
| Leader / Integration | 이진석 |
| Data Engineer | 김민우 |
| Data Engineer | 김나연 |
| Model Architect | 김보윤 |
| Experimentation Lead | 황유민 |

---

## Phase 2: EDA & 데이터 전처리 (12/05 ~ 12/09)

### 주요 작업
- 데이터 탐색적 분석 (EDA)
- YOLO 데이터셋 포맷 변환
- 데이터 전처리 파이프라인 구축

### 주요 발견
- 학습 데이터: 232개 이미지, **56개 클래스**
- 테스트 데이터: 843개 이미지
- **클래스 불균형 심각** (1:80 비율)
- 이미지-어노테이션 불일치 발견

---

## Phase 3: Baseline 모델 개발 (12/09 ~ 12/12)

### 주요 작업
- YOLO 베이스라인 모델 구현 (보윤님)
- Ubuntu 환경에서 학습 파이프라인 구축
- 초기 학습 및 Kaggle 제출

### 첫 Kaggle 제출
| Submission | Score | 내용 |
|------------|-------|------|
| #1 | **0.82** | YOLO12m Baseline (Ubuntu) |

---

## Phase 4: AIHub 데이터 증강 시도 (12/11 ~ 12/15)

### 4-1. 복합경구제 시도 (실패)

**시도**: AIHub 복합경구제 데이터에서 56개 클래스 필터링

| 시도 | 결과 |
|------|------|
| 56개 클래스 필터링 | **0.6** (이미지당 라벨 1개만 → bbox 1개만 검출) |

**문제점**:
1. 이미지당 라벨링 하나만 가져옴 → bbox 1개만 학습/검출
2. 전체 라벨링 사용 시 클래스 폭증

### 4-2. 단일경구제 전환

**시도**: AIHub 단일경구제 데이터 활용

**문제점**:
- 이미지당 알약 1개
- 배경 어둡고 붉은색 → 테스트/캐글 데이터와 다름
- 데이터셋 용량 TB 단위

**해결**:
1. 라벨링만 먼저 다운로드
2. 56개 클래스로 필터링
3. 필요한 데이터셋만 다운로드 (1.5TB, 23시간 소요)
4. 클래스당 100개씩 추출하여 팀 공유 (6GB)

### 결과
| Submission | Score | 내용 |
|------------|-------|------|
| - | **0.822** | Kaggle + 단일경구제 (유의미한 개선 X) |

---

## Phase 5: 추가 클래스 확보 (12/17 ~ 12/18)

### 강사님 디렉션
- 테스트 이미지에 **18개 추가 클래스** 존재 확인
- 복합경구제 TL/TS 1, 3, 4에서 추가 클래스 확보 제안

### 데이터 확장
1. TL/TS 1, 3, 4에서 18개 추가 클래스 데이터셋 추가
2. TL/TS 1, 3, 4, 5, 6, 7, 8 다운로드
3. 캐글 56개 + 추가 18개 = **74개 클래스** 구성

### ROI Crop 시도 (실패)

**시도**: 캐글/AIHub 데이터에서 알약 영역 크롭 후 학습

**문제점**:
- bbox를 이미지 전체로 설정하고 학습
- 결과: 알약들의 bbox 검출 불가

---

## Phase 6: 2-Stage Pipeline 도입 (12/18)

### 핵심 전환점

**기존 방식의 한계**:
- End-to-end로 Detection + Classification 동시 학습
- 클래스 불균형, 데이터 부족으로 성능 한계

**새로운 접근**:
```
Stage 1: Detector (단일 클래스 "Pill")
    → 위치와 박싱만 담당

Stage 2: Classifier (74개 클래스)
    → 분류만 담당
```

### 아키텍처
```
┌─────────────────────────────────────────────────────────────┐
│                    2-Stage Pipeline                         │
├─────────────────────────────────────────────────────────────┤
│  Stage 1: YOLO11m Detector                                  │
│  ├── Input: 원본 이미지                                     │
│  ├── Output: Bounding Boxes                                 │
│  └── Task: 알약 위치 검출 (Single class)                    │
├─────────────────────────────────────────────────────────────┤
│  Stage 2: ConvNeXt Classifier                               │
│  ├── Input: 크롭된 알약 이미지 (224x224)                    │
│  ├── Output: K-code + Confidence                            │
│  └── Task: 알약 종류 분류 (74 classes)                      │
└─────────────────────────────────────────────────────────────┘
```

### Kaggle 제출
| Submission | Score | 내용 |
|------------|-------|------|
| #3 | **0.920** | 2-Stage (YOLO + YOLO-cls) |
| #4 | **0.963** | 2-Stage (YOLO + ConvNeXt) |

---

## Phase 7: 데이터 정제 & 최적화 (12/18 ~ 12/19)

### 데이터 정제 (cleanup_detector_data.py)

**정제 기준**:
| 항목 | 기준 | 이유 |
|------|------|------|
| bbox 개수 | 2~4개 | Kaggle 테스트와 동일 |
| IoU 임계값 | 0.7 | 진짜 중복만 검출 |
| bbox 크기 | 30px 이상 | 너무 작은 bbox 제외 |
| 종횡비 | 3.5 이하 | 비정상 형태 제외 |
| 면적비 | 0.3%~15% | 이미지 대비 적정 크기 |

### 핵심 개선
**문제**: 기존 코드는 74개 타겟 클래스 폴더만 스캔 → bbox 누락

**해결**: 모든 K-code 폴더 스캔하여 모든 bbox 수집

### Kaggle 제출
| Submission | Score | 내용 |
|------------|-------|------|
| #5 | 0.965 | AIHub 데이터 추가 |
| **#6** | **0.96703** | **데이터셋 정제** |

---

## Phase 8: 비즈니스 방향성 & 마무리 (12/18 ~ 12/22)

### 12/18 팀 회의 - 비즈니스 아젠다 논의

**프로젝트 배경**:
> "유저가 모바일 앱으로 복용 중인 약 사진을 찍으면, 해당 약에 대한 정보를 제공"

**팀원별 발표**:

| 담당자 | 주제 | 핵심 내용 |
|--------|------|----------|
| **김민우** | 서비스 타당성 | B2C 공익성 있으나, B2B 모델 병행 권장 |
| **황유민** | 챗봇 프롬프트 | LLM 연동, Uncertainty Handling (confidence 기반 3단계) |
| **김나연** | B2B 시장조사 | 응급구조대/수사기관 높은 가치 |
| **김보윤** | 모델 배포 | Cloud 방식 채택 (앱 ~20MB) |
| **이진석** | 2-Stage 설명 | 팀원 테스트 지원 (submit.py 사용법) |

**핵심 결정사항**:
- **Cloud 아키텍처**: 앱 용량 ~20MB, 모델 업데이트 용이
- **Uncertainty Handling**:
  - >= 0.9: 결과 표시
  - 0.7~0.9: "다시 촬영해주세요"
  - < 0.7: "약사에게 문의하세요"
- **B2B SaaS 모델**: 응급구조대, 수사기관 타겟

### 추가 실험 (실패)
| 실험 | Score | 원인 |
|------|-------|------|
| imgsz 1280 | 0.713 | 학습/추론 설정 불일치 |
| imgsz 1280 + TTA | 0.533 | bbox 정밀도 저하 |

### 결론
- 기존 640 모델 유지 (Best Score 0.96703)
- mAP@[0.75:0.95]는 bbox 정밀도에 민감

---

## 점수 개선 히스토리

```
0.82 ──────────────────────────────────────────── Baseline (YOLO12m)
  │
  │  ↓ 복합경구제 56클래스 필터링
  │
0.6 ───────────────────────────────────────────── bbox 1개만 검출
  │
  │  ↑ 단일경구제 + 56클래스 필터링
  │
0.822 ─────────────────────────────────────────── 유의미한 개선 X
  │
  │  ↑ 2-Stage Pipeline 도입 (+0.10)
  │
0.920 ─────────────────────────────────────────── YOLO-cls
  │
  │  ↑ ConvNeXt Classifier (+0.043)
  │
0.963 ───────────────────────────────────────────
  │
  │  ↑ 데이터셋 정제 (+0.004)
  │
0.967 ─────────────────────────────────────────── Best Score
```

---

## 팀원별 기여

### 이진석 (Leader / Integration)
- 프로젝트 구조 설계
- 2-Stage Pipeline 설계 및 구현
- AIHub 데이터 추출 로직 개선
- 데이터 정제 스크립트 개발
- 최종 모델 통합

### 김민우 (Data Engineer / 서비스 타당성)
- 데이터 EDA 및 발표
- YOLO 데이터셋 변환
- AIHub 데이터 필터링 및 추출
- 데이터 증강 모듈 개발
- **12/18**: B2C/B2B 타당성 분석

### 김나연 (Data Engineer / B2B 시장조사)
- 데이터 EDA 노트북
- 데이터 전처리 모듈화
- AIHub TL 데이터셋 확보
- PyTorch Dataset 구현
- **12/18**: B2B 시장조사 (응급구조대/수사기관)

### 김보윤 (Model Architect / 배포)
- YOLO 베이스라인 설계
- Ubuntu 학습 파이프라인
- 시드 고정 & 체크포인트
- 모델 실험 및 자동화
- **12/18**: Cloud vs On-Device 아키텍처 검토

### 황유민 (Experimentation Lead / 챗봇)
- W&B 실험 추적 시스템
- 실험 스케줄링
- 성능 지표 모니터링
- 실험 로그 관리
- **12/18**: LLM 챗봇 프롬프트 설계

---

## 핵심 성공 요인

1. **2-Stage 분리**: Detection과 Classification 독립 최적화
2. **데이터셋 정제**: 테스트 환경과 유사한 3~4개 bbox 이미지만 사용
3. **ConvNeXt 유지**: YOLO-cls와 분류 정확도 비슷하여 변경 불필요

---

## 핵심 실패 요인 및 교훈

| 시도 | 실패 원인 | 교훈 |
|------|----------|------|
| AIHub 복합경구제 | 이미지당 bbox 1개만 학습 | 데이터 구조 이해 필수 |
| 전체 라벨링 사용 | 클래스 폭증 → mAP 급락 | 클래스 수 관리 중요 |
| ROI Crop | bbox=이미지 전체 | 크롭 로직 검증 필요 |
| imgsz 1280 | 학습/추론 불일치 | 설정 일관성 유지 |

---

## 프로젝트 통계

| 항목 | 수치 |
|------|------|
| 총 커밋 수 | ~180개 |
| PR 수 | 86개 |
| 협업일지 | 40개 |
| 실험 로그 | 12개 |
| 회의록 | 4개 |
| 모델 실험 | 30+ 버전 |
| Kaggle 제출 | 8회 |

---

## 결론

3주간의 프로젝트를 통해 **Baseline 0.82에서 0.96703까지 +18% 개선** 달성.

핵심은 **End-to-end 접근법의 한계를 인식**하고 **2-Stage Pipeline으로 전환**한 것.
수많은 시행착오(복합경구제, ROI Crop 등)를 통해 **데이터 품질의 중요성**을 체감.
